{% extends "base.html" %}

{% block title %}Attendance Devices{% endblock %}

{% block content %}
<div class="col-12">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-upc-scan me-2"></i>
                Attendance Devices
            </h5>
            <a href="{{ url_for('devices.add') }}" class="btn btn-light btn-sm">
                <i class="bi bi-plus-circle"></i> Add Device
            </a>
        </div>
        <div class="card-body">
            <!-- Quick Add Options -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-fingerprint me-2"></i>ZKTeco Device</h5>
                            <p>Connect to ZKTeco biometric fingerprint devices, such as the U280 series</p>
                            <p class="mb-0">Format: <code>hostname:port</code> (e.g., <code>erp.mir.ae:4077</code>) or full URL.</p>
                            <div class="mt-3">
                                <a href="{{ url_for('devices.add') }}" class="btn btn-primary">Add ZKTeco Device</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-camera-fill me-2"></i>Hikvision DS-K1T342MFWX-E1</h5>
                            <p>Connect to Hikvision face recognition terminals using their ISAPI interface</p>
                            <p class="mb-0">Requires device IP, admin username and password to connect.</p>
                            <div class="mt-3">
                                <a href="{{ url_for('devices.add_hikvision') }}" class="btn btn-primary">Add Hikvision Device</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Device Information Alert -->
            <div class="alert alert-info" role="alert">
                <h5><i class="bi bi-info-circle-fill me-2"></i>Device Connection Information</h5>
                <p class="mb-0">All devices must be accessible from the server where this application is deployed.</p>
                <p class="mt-2 mb-0"><strong>Note:</strong> Connection testing may not work from all environments due to network restrictions.</p>
            </div>
            
            <!-- Status Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-check-circle me-2"></i> Online</h5>
                            <h3 class="online-count">0</h3>
                            <p class="mb-0 online-percentage">0% of devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-danger text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-x-circle me-2"></i> Offline</h5>
                            <h3 class="offline-count">0</h3>
                            <p class="mb-0 offline-percentage">0% of devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-dark h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-exclamation-triangle me-2"></i> Error</h5>
                            <h3 class="error-count">0</h3>
                            <p class="mb-0 error-percentage">0% of devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-collection me-2"></i> Total</h5>
                            <h3 class="total-count">{{ devices|length }}</h3>
                            <p class="mb-0">Registered devices</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Devices Table -->
            <div class="table-responsive">
                <table class="table table-hover" id="devicesTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Device ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <th>Last Ping</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr data-device-id="{{ device.id }}">
                            <td>{{ device.name }}</td>
                            <td>{{ device.device_id }}</td>
                            <td>{{ device.device_type }}</td>
                            <td>{{ device.location or 'N/A' }}</td>
                            <td>{{ device.ip_address or 'N/A' }}</td>
                            <td>
                                <span class="badge device-status
                                    {% if device.status == 'online' %}bg-success
                                    {% elif device.status == 'offline' %}bg-danger
                                    {% else %}bg-warning{% endif %}">
                                    {{ device.status|capitalize }}
                                </span>
                            </td>
                            <td>
                                {% if device.last_ping %}
                                    <span data-timestamp="{{ device.last_ping.isoformat() }}">
                                        {{ device.last_ping.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </span>
                                {% else %}
                                    Never
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('devices.logs', device_id=device.id) }}" class="btn btn-sm btn-outline-secondary" title="View Logs">
                                        <i class="bi bi-journal-text"></i>
                                    </a>
                                    <a href="{{ url_for('devices.edit', device_id=device.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Device">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form method="post" action="{{ url_for('devices.check_device', device_id=device.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-info" title="Check Status">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </form>
                                    <a href="{{ url_for('devices.troubleshoot_device', device_id=device.id) }}" class="btn btn-sm btn-outline-warning" title="Troubleshoot">
                                        <i class="bi bi-tools"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-device" 
                                           data-bs-toggle="modal" data-bs-target="#deleteDeviceModal" 
                                           data-device-id="{{ device.id }}" data-device-name="{{ device.name }}" title="Delete Device">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center">No devices registered</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Device Modal -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteDeviceForm" method="post" action="">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the device <strong id="deviceName"></strong>?</p>
                    <p class="text-danger">This action cannot be undone and will also delete all associated logs.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Device</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/devices.js') }}"></script>
<script>
    $(document).ready(function() {
        // Initialize DataTable only if table has rows
        if ($('#devicesTable tbody tr').length > 0 && $('#devicesTable tbody tr').first().find('td').length > 1) {
            $('#devicesTable').DataTable({
                "order": [[0, "asc"]],
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "language": {
                    "search": "Filter:"
                }
            });
        } else {
            console.log('No data in devicesTable or only empty row, skipping DataTable initialization');
        }
        
        // Setup delete device modal
        $('.delete-device').on('click', function() {
            var deviceId = $(this).data('device-id');
            var deviceName = $(this).data('device-name');
            
            $('#deviceName').text(deviceName);
            $('#deleteDeviceForm').attr('action', '/devices/delete/' + deviceId);
        });
        
        // Auto-refresh device statuses
        refreshDeviceStatus();
        setInterval(refreshDeviceStatus, 30000); // Update every 30 seconds
    });
</script>
{% endblock %}