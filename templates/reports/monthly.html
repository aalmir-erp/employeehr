{% extends 'base.html' %}

{% block title %}Monthly Reports{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-calendar-month"></i> Monthly Attendance Report</h2>
                <div class="btn-group">
                    <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Reports
                    </a>
                    <button id="exportBtn" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn btn-outline-secondary print-report-btn">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <!-- Date Selection -->
                        <div class="col-md-3">
                            <label for="year" class="form-label">Year</label>
                            <select class="form-control" id="year" name="year">
                                {% for y in years %}
                                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="month" class="form-label">Month</label>
                            <select class="form-control" id="month" name="month">
                                {% for m in range(1, 13) %}
                                <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m|month_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Department Filter -->
                        <div class="col-md-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-control" id="department" name="department">
                                <option value="all" {% if selected_department == 'all' %}selected{% endif %}>All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Employee Filter -->
                        <div class="col-md-3">
                            <label for="employee_id" class="form-label">Employee</label>
                            <select class="form-select employee-select" id="employee_id" name="employee_id">
                                <option value="all" {% if selected_employee_id == 'all' %}selected{% endif %}>All Employees</option>
                                {% for emp in all_employees %}
                                <option value="{{ emp.id }}" {% if selected_employee_id == emp.id|string %}selected{% endif %}>
                                    {{ emp.name }} ({{ emp.employee_code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Search button -->
                        <div class="col-12 d-flex align-items-end mt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-search"></i> Generate Report
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="bi bi-x-circle"></i> Reset Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {% if statistics %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Monthly Statistics - {{ selected_month|month_name }} {{ selected_year }}</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Summary</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Working Days
                            <span class="badge bg-primary rounded-pill">{{ statistics.working_days }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Present Days
                            <span class="badge bg-success rounded-pill">{{ statistics.present }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Absent Days
                            <span class="badge bg-danger rounded-pill">{{ statistics.absent }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Late Arrivals
                            <span class="badge bg-warning text-dark rounded-pill">{{ statistics.late }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Holidays
                            <span class="badge bg-info text-white rounded-pill">{{ statistics.holidays }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Average Hours/Day
                            <span class="badge bg-secondary rounded-pill">{{ '%.2f'|format(statistics.avg_hours) }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Total Overtime
                            <span class="badge bg-dark rounded-pill">{{ '%.2f'|format(statistics.total_overtime) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if summary %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Department Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover{% if summary %} datatable{% endif %}">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Total Employees</th>
                                    <th>Present %</th>
                                    <th>Absent %</th>
                                    <th>Late %</th>
                                    <th>Avg. Hours</th>
                                    <th>Total Overtime</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept in summary %}
                                <tr>
                                    <td>{{ dept.department or 'Unassigned' }}</td>
                                    <td>{{ dept.total_employees }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ dept.present_percent }}%">
                                                {{ '%.1f'|format(dept.present_percent) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ dept.absent_percent }}%">
                                                {{ '%.1f'|format(dept.absent_percent) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ dept.late_percent }}%">
                                                {{ '%.1f'|format(dept.late_percent) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ '%.2f'|format(dept.avg_hours) }}</td>
                                    <td>{{ '%.2f'|format(dept.total_overtime) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No data available for this month</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> Select a year and month to generate the monthly report.
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if statistics %}
        // Monthly attendance chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        
        const monthlyData = {
            labels: ['Present', 'Absent', 'Late', 'Holidays'],
            datasets: [{
                label: 'Attendance Distribution',
                data: [
                    {{ statistics.present }},
                    {{ statistics.absent }},
                    {{ statistics.late }},
                    {{ statistics.holidays }}
                ],
                backgroundColor: [
                    '#28a745', // Present (Success)
                    '#dc3545', // Absent (Danger)
                    '#ffc107', // Late (Warning)
                    '#17a2b8'  // Holidays (Info)
                ],
                borderWidth: 1
            }]
        };
        
        new Chart(monthlyCtx, {
            type: 'doughnut',
            data: monthlyData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Monthly Attendance Distribution'
                    }
                }
            }
        });
        {% endif %}
        
        // Export button handler
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Create export URL with current filters
            let year = document.getElementById('year').value;
            let month = document.getElementById('month').value;
            let department = document.getElementById('department').value;
            let employeeId = document.getElementById('employee_id').value;
            
            window.location.href = `{{ url_for('reports.export_csv') }}?type=monthly&year=${year}&month=${month}&department=${department}&employee_id=${employeeId}`;
        });
        
        // Initialize Select2 for employee dropdown to make it searchable
        if ($.fn.select2) {
            $('.employee-select').select2({
                theme: 'bootstrap4',
                placeholder: "Select an employee",
                allowClear: true
            });
        }
    });
    
    // Function to reset all filters
    function resetFilters() {
        // Reset to current month and year
        document.getElementById('year').value = {{ selected_year }};
        document.getElementById('month').value = {{ selected_month }};
        document.getElementById('department').value = 'all';
        
        // Reset employee dropdown and trigger change event for select2
        const employeeSelect = document.getElementById('employee_id');
        employeeSelect.value = 'all';
        if ($.fn.select2) {
            $(employeeSelect).trigger('change');
        }
        
        // Submit the form
        document.querySelector('form').submit();
    }
</script>
{% endblock %}