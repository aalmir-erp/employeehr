{% extends "base.html" %}

{% block title %}Edit Bonus Submission{% endblock %}

{% block styles %}
{% include "bonus/help/evaluation_guide.html" %}
{{ super() }}
<style>
    .evaluation-table th {
        position: sticky;
        top: 0;
        background-color: var(--bs-body-bg);
        z-index: 10;
    }
    .evaluation-table .employee-name {
        position: sticky;
        left: 0;
        background-color: var(--bs-body-bg);
        z-index: 5;
    }
    .score-cell {
        width: 100px;
        text-align: center;
    }
    .score-input {
        width: 60px;
        text-align: center;
        margin: 0 auto;
    }
    .saving-indicator {
        display: none;
        color: var(--bs-info);
    }
    .save-success {
        display: none;
        color: var(--bs-success);
    }
    .save-error {
        display: none;
        color: var(--bs-danger);
    }
    .total-points {
        font-weight: bold;
        color: var(--bs-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('bonus.supervisor_dashboard') }}">Bonus Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Submission</li>
                </ol>
            </nav>
            <h1 class="mb-3">Bonus Evaluation</h1>
            <p class="lead">
                Department: <strong>{{ submission.department }}</strong> | 
                Period: <strong>{{ submission.period.name }}</strong> | 
                Status: <span class="badge {% if submission.status == 'draft' %}bg-warning{% elif submission.status == 'rejected' %}bg-danger{% endif %}">{{ submission.status }}</span>
            </p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Employee Evaluations</h4>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#evaluationGuideModal">
                            <i class="bi bi-info-circle me-1"></i> Evaluation Guide
                        </button>
                        <form method="post" action="{{ url_for('bonus.submit_evaluation', submission_id=submission.id) }}" style="display: inline;">
                            {{ form.hidden_tag() if form else '' }}
                            <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to submit this evaluation for HR review?')">
                                Submit for Review
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    {% if employees and questions %}
                    <div class="table-responsive">
                        <table class="table table-bordered evaluation-table">
                            <thead>
                                <tr>
                                    <th class="employee-name">Employee</th>
                                    {% for question in questions %}
                                    <th class="score-cell" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ question.question_text }}">
                                        <span class="d-block text-truncate" style="max-width: 150px;">{{ question.question_text }}</span>
                                        <small class="d-block text-muted">({{ question.min_value }}-{{ question.max_value }})</small>
                                    </th>
                                    {% endfor %}
                                    <th class="score-cell">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in employees %}
                                <tr>
                                    <td class="employee-name">{{ employee.name }}</td>
                                    {% for question in questions %}
                                    <td class="score-cell">
                                        <form method="post" action="{{ url_for('bonus.save_single_evaluation') }}" class="single-evaluation-form">
                                            <input type="hidden" name="submission_id" value="{{ submission.id }}"/>
                                            <input type="hidden" name="employee_id" value="{{ employee.id }}"/>
                                            <input type="hidden" name="question_id" value="{{ question.id }}"/>
                                            <input type="number" 
                                                class="form-control score-input"
                                                name="value"
                                                data-employee-id="{{ employee.id }}"
                                                data-question-id="{{ question.id }}"
                                                min="{{ question.min_value }}"
                                                max="{{ question.max_value }}"
                                                value="{% if employee.id in evaluation_matrix and question.id in evaluation_matrix[employee.id] %}{{ evaluation_matrix[employee.id][question.id].value }}{% else %}{{ question.default_value }}{% endif %}">
                                               
                                            </form>
                                      
                                    </td>
                                    {% endfor %}
                                    <td class="score-cell">
                                        <span class="total-points" id="total-{{ employee.id }}">0.0</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No employees or evaluation questions found for this department.
                    </div>
                    {% endif %}
                    
                    {% if employees and questions and submission.status in ['draft', 'rejected'] %}
                    <div class="mt-4 text-center">
                        <form method="post" action="{{ url_for('bonus.submit_evaluation', submission_id=submission.id) }}" style="display: inline;" id="final-submit-form">
                            {{ form.hidden_tag() if form else '' }}
                            <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('Are you sure you want to submit this evaluation for HR review?')">
                                <i class="bi bi-check-circle me-2"></i>Submit for Review
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Question Details</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Range</th>
                                    <th>Weight</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in questions %}
                                <tr>
                                    <td>
                                        <strong>Q{{ loop.index }}:</strong> {{ question.question_text }}
                                    </td>
                                    <td>{{ question.min_value }} - {{ question.max_value }}</td>
                                    <td>{{ question.weight }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Submission Information</h4>
                </div>
                <div class="card-body">
                    <p>You're currently working on a <span class="badge {% if submission.status == 'draft' %}bg-warning{% else %}bg-danger{% endif %}">{{ submission.status }}</span> submission.</p>
                    
                    <h5 class="mt-4">Next Steps:</h5>
                    <ol>
                        <li>Rate each employee on all criteria</li>
                        <li>Verify that all evaluations are complete</li>
                        <li>Click "Submit for Review" to send to HR</li>
                    </ol>
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Once submitted, evaluations cannot be modified unless rejected by HR.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submitModalLabel">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit this evaluation for HR review?</p>
                <p>Once submitted, you won't be able to make changes unless it's rejected by HR.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{{ url_for('bonus.submit_evaluation', submission_id=submission.id) }}">
                    {{ form.hidden_tag() if form else '' }}
                    <button type="submit" class="btn btn-success">Submit for Review</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let pendingRequests = 0;
        let isSubmitting = false;
    
        const showLoader = (input) => {
            let cell = input.closest('td');
            if (!cell.querySelector('.saving-indicator')) {
                let span = document.createElement('span');
                span.classList.add('saving-indicator');
                span.innerHTML = 'Saving...';
                cell.appendChild(span);
            }
            cell.querySelector('.saving-indicator').style.display = 'inline';
        };
    
        const hideLoader = (input) => {
            let cell = input.closest('td');
            let span = cell.querySelector('.saving-indicator');
            if (span) {
                span.style.display = 'none';
            }
        };
    
        document.querySelectorAll('.score-input').forEach(input => {
            input.addEventListener('change', function () {
                console.log("Score input changed");  // Debug log
                const value = parseFloat(this.value);
                const min = parseFloat(this.min);
                const max = parseFloat(this.max);
                console.log(value,min,max,"================================")
                if (value < min || value > max) {
                    alert(`Value must be between ${min} and ${max}`);
                    return;
                }

                const form = this.closest('form');
                const formData = new FormData(form);
                const url = form.getAttribute('action');
                console.log("Submitting to:", url);  // Debug log

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => response.json())
                .then(data => {
                    console.log("Server response:", data);
                    if (!data.success) {
                        alert(data.message || 'Error saving score.');
                    }
                }).catch((err) => {
                    console.error('Fetch error:', err);
                    alert('Network error.');
                });
            });
        });

    
        // Intercept the submit form
        const submitBtn = document.querySelector('#final-submit-form button[type="submit"]');
        const form = document.getElementById('final-submit-form');
    
        if (form) {
            form.addEventListener('submit', function (e) {
                if (pendingRequests > 0) {
                    e.preventDefault();
                    isSubmitting = true;
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Saving scores...";
                }
            });
        }
    });
    </script>

{% endblock %}


