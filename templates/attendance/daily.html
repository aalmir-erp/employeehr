{% extends "base.html" %}

{% block title %}Daily Attendance{% endblock %}

{% block extra_head %}
<style>
    /* Odoo 9 inspired styling */
    .o-card {
        border-radius: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
    }
    
    .o-card-header {
        background-color: #f5f5f5;
        padding: 8px 16px;
        border-bottom: 1px solid #ddd;
    }
    
    .o-card-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin: 0;
    }
    
    .o-filters {
        background-color: #f5f5f5;
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    
    .o-table {
        margin-bottom: 0;
    }
    
    .o-table thead th {
        background-color: #f9f9f9;
        font-weight: 500;
        border-bottom: 2px solid #ddd;
        font-size: 0.9rem;
    }
    
    .o-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .o-table tbody tr:hover {
        background-color: #f0f8ff;
    }
    
    .o-table tbody td {
        vertical-align: middle;
        padding: 8px 12px;
        border-top: 1px solid #eee;
    }
    
    .o-button {
        border-radius: 0;
        font-weight: 500;
        padding: 6px 12px;
    }
    
    .o-button-primary {
        background-color: #875A7B;
        border-color: #875A7B;
    }
    
    .o-button-primary:hover {
        background-color: #784C6C;
        border-color: #784C6C;
    }
    
    .o-date-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
    }
    
    .o-date-nav h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .o-nav-btn {
        background: none;
        border: none;
        color: #875A7B;
        cursor: pointer;
        padding: 5px 10px;
        transition: background-color 0.2s;
    }
    
    .o-nav-btn:hover {
        background-color: rgba(135, 90, 123, 0.1);
        border-radius: 3px;
    }
    
    .o-nav-btn i {
        margin: 0 5px;
    }
    
    .o-badge {
        border-radius: 2px;
        font-weight: 500;
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .o-tooltip {
        position: relative;
        display: inline-block;
    }
    
    .o-tooltip .o-tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 3px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .o-tooltip .o-tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
    }
    
    .o-tooltip:hover .o-tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    .o-filter-label {
        font-weight: 500;
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 4px;
    }
    
    /* Custom theme compatibility */
    [data-bs-theme=dark] .o-card,
    [data-bs-theme=dark] .o-card-header,
    [data-bs-theme=dark] .o-filters,
    [data-bs-theme=dark] .o-date-nav {
        background-color: #2b3035;
        border-color: #495057;
    }
    
    [data-bs-theme=dark] .o-table thead th {
        background-color: #343a40;
        border-bottom-color: #495057;
    }
    
    [data-bs-theme=dark] .o-table tbody tr:hover {
        background-color: #343a40;
    }
    
    [data-bs-theme=dark] .o-table tbody td {
        border-top-color: #495057;
    }
    
    [data-bs-theme=dark] .o-nav-btn {
        color: #adb5bd;
    }
    
    [data-bs-theme=dark] .o-nav-btn:hover {
        background-color: rgba(173, 181, 189, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="col-12">
    <div class="o-card">
        <div class="o-card-header d-flex justify-content-between align-items-center">
            <h5 class="o-card-title">
                <i class="bi bi-calendar-date me-2"></i>
                Daily Attendance
            </h5>
            <div>
                {% if current_user.is_admin %}
                <a href="{{ url_for('attendance.missing_punches') }}" class="btn btn-outline-warning o-button">
                    <i class="bi bi-exclamation-triangle"></i> Missing Punches
                    {% if missing_punches_count and missing_punches_count > 0 %}
                    <span class="badge rounded-pill bg-danger">{{ missing_punches_count }}</span>
                    {% endif %}
                </a>
                {% endif %}
                <a href="{{ url_for('attendance.manual_entry') }}" class="btn btn-outline-primary o-button">
                    <i class="bi bi-pencil-square"></i> Manual Entry
                </a>
                {% if current_user.is_admin or current_user.has_role('hr') %}

                <a href="{{ url_for('reports.daily') }}?date={{ selected_date.strftime('%Y-%m-%d') }}" class="btn btn-primary o-button o-button-primary">
                    <i class="bi bi-file-earmark-text"></i> Generate Report 
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters -->
        <div class="o-filters">
            <form method="get" action="{{ url_for('attendance.daily') }}" id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="date" class="o-filter-label">Date</label>
                    <input type="date" name="date" id="date" value="{{ selected_date.strftime('%Y-%m-%d') }}" class="form-control">
                </div>
                
                <div class="col-md-3">
                    <label for="department" class="o-filter-label">Department</label>
                    <select class="form-select department-select" id="department" name="department">
                        <option value="all">All Departments</option>
                        {% for dept in departments %}
                            <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary o-button o-button-primary">
                        <i class="bi bi-search"></i> View
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Date Navigation -->
        <div class="o-date-nav">
            <button onclick="window.location='{{ url_for('attendance.daily', date=(selected_date - day_delta).strftime('%Y-%m-%d')) }}'" class="o-nav-btn">
                <i class="bi bi-arrow-left"></i> Previous Day
            </button>
            <h4>{{ selected_date.strftime('%A') }}, {{ selected_date|format_date }}</h4>
            <button onclick="window.location='{{ url_for('attendance.daily', date=(selected_date + day_delta).strftime('%Y-%m-%d')) }}'" class="o-nav-btn">
                Next Day <i class="bi bi-arrow-right"></i>
            </button>
        </div>
        
        <!-- Attendance Table -->
        <div class="table-responsive">
            <table class="table o-table" id="dailyAttendanceTable">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Shift</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Status</th>
                        <th>Break</th>
                        <th>Work Hours</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="ms-2">
                                    <div>{{ record.employee.name }}</div>
                                    <div class="text-muted small">{{ record.employee.employee_code }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ record.employee.department or 'N/A' }}</td>
                        <td>
                            {% if record.shift %}
                                <span class="shift-color-block" style="background-color: {{ record.shift.color_code }}"></span>
                                {{ record.shift.name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if record.check_in %}
                                <span class="text-success">{{ record.check_in.strftime('%H:%M:%S') }}</span>
                            {% else %}
                                <span class="text-danger o-tooltip">
                                    <i class="bi bi-exclamation-circle"></i> Missing
                                    <span class="o-tooltip-text">Check-in time missing. Click Edit to add it.</span>
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.check_out %}
                                <span class="text-success">{{ record.check_out.strftime('%H:%M:%S') }}</span>
                            {% else %}
                                <span class="text-danger o-tooltip">
                                    <i class="bi bi-exclamation-circle"></i> Missing
                                    <span class="o-tooltip-text">Check-out time missing. Click Edit to add it.</span>
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge o-badge
                                {% if record.status == 'present' %}bg-success
                                {% elif record.status == 'absent' %}bg-danger
                                {% elif record.status == 'late' %}bg-warning
                                {% elif record.status == 'half-day' %}bg-info
                                {% else %}bg-secondary{% endif %}">
                                {{ record.status|capitalize }}
                            </span>
                        </td>
                        <td class="text-center">{{ '%.1f'|format(record.break_duration if record.break_duration is not none else 0) }} hrs</td>
                        <td class="text-center">{{ '%.1f'|format(record.work_hours if record.work_hours is not none else 0) }} hrs</td>
                        <td>
                            <a href="{{ url_for('attendance.employee_attendance', employee_id=record.employee.id) }}?date={{ selected_date.strftime('%Y-%m-%d') }}" class="btn btn-sm btn-outline-primary o-tooltip">
                                <i class="bi bi-eye"></i>
                                <span class="o-tooltip-text">View employee's full attendance history</span>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-warning edit-record o-tooltip" 
                                    data-bs-toggle="modal" data-bs-target="#editRecordModal"
                                    data-record-id="{{ record.id }}"
                                    data-employee-name="{{ record.employee.name }}"
                                    data-check-in="{{ record.check_in.strftime('%H:%M') if record.check_in else '' }}"
                                    data-check-out="{{ record.check_out.strftime('%H:%M') if record.check_out else '' }}"
                                    data-status="{{ record.status }}">
                                <i class="bi bi-pencil"></i>
                                <span class="o-tooltip-text">Edit this attendance record</span>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-calendar-x text-secondary" style="font-size: 2rem;"></i>
                                <p class="mb-0 mt-2">No attendance records found for this date</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Edit Record Modal -->
<div class="modal fade" id="editRecordModal" tabindex="-1" aria-labelledby="editRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 0; border: 1px solid #ddd;">
            <form method="post" action="{{ url_for('attendance.manual_entry') }}">
                <input type="hidden" name="record_id" id="recordId">
                <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                
                <div class="modal-header" style="background-color: #875A7B; color: white; border-bottom: 1px solid #784C6C;">
                    <h5 class="modal-title" id="editRecordModalLabel" style="font-weight: 500; font-size: 1.1rem;">
                        <i class="bi bi-pencil-square me-2"></i>Edit Attendance Record
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label o-filter-label">Employee</label>
                        <input type="text" class="form-control" id="employeeName" readonly>
                        <div class="form-text mt-1">
                            <i class="bi bi-info-circle"></i> 
                            This record is for {{ selected_date.strftime('%A, %B %d, %Y') }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="checkIn" class="form-label o-filter-label">Check In Time</label>
                        <input type="time" class="form-control" id="checkIn" name="check_in">
                        <div class="form-text mt-1">
                            Format: 24-hour (HH:MM)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="checkOut" class="form-label o-filter-label">Check Out Time</label>
                        <input type="time" class="form-control" id="checkOut" name="check_out">
                        <div class="form-text mt-1">
                            Format: 24-hour (HH:MM)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label o-filter-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                            <option value="half-day">Half Day</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" class="btn btn-outline-secondary o-button" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary o-button o-button-primary">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // More defensive checks before initializing DataTable
        try {
            // Check if table exists in DOM
            var table = $('#dailyAttendanceTable');
            if (table.length === 0) {
                console.warn('Table #dailyAttendanceTable not found in the DOM');
                return;
            }
            
            // Check if there are enough rows to warrant a DataTable
            if (table.find('tbody tr').length <= 1) {
                console.log('No data or only one row in #dailyAttendanceTable, skipping DataTable initialization');
                return;
            }
            
            // Check if a single row contains the "No records found" message
            if (table.find('tbody tr').length === 1 && table.find('tbody tr td[colspan]').length > 0) {
                console.log('#dailyAttendanceTable contains only "No records" message row, skipping DataTable initialization');
                return;
            }
            
            // Check if DataTable is already initialized
            if ($.fn.dataTable.isDataTable('#dailyAttendanceTable')) {
                console.log('#dailyAttendanceTable already initialized as DataTable');
                return;
            }
            
            // Safe to initialize
            table.DataTable({
                "order": [[0, "asc"]],
                "pageLength": 25,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "language": {
                    "search": "Search:",
                    "searchPlaceholder": "Employee name, department...",
                    "emptyTable": "No attendance records found for this date",
                    "info": "Showing _START_ to _END_ of _TOTAL_ records",
                    "lengthMenu": "Show _MENU_ records per page"
                }
            });
        } catch (e) {
            console.error('Error initializing DataTable for #dailyAttendanceTable:', e);
        }
        
        // Edit record modal handler
        $('.edit-record').on('click', function() {
            var recordId = $(this).data('record-id');
            var employeeName = $(this).data('employee-name');
            var checkIn = $(this).data('check-in');
            var checkOut = $(this).data('check-out');
            var status = $(this).data('status');
            
            $('#recordId').val(recordId);
            $('#employeeName').val(employeeName);
            $('#checkIn').val(checkIn);
            $('#checkOut').val(checkOut);
            $('#status').val(status);
        });
        
        // Auto-submit filter form when date or department changes
        $('#date, #department').on('change', function() {
            $('#filterForm').submit();
        });
    });
</script>
{% endblock %}