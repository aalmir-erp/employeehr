<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Attendance Management System{% endblock %}</title>
    
    <!-- Bootstrap CSS from Replit CDN -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <!-- jQuery for DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- DataTables for enhanced tables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}" media="print">
    <style>
        /* General layout styles */
        .sidebar {
            min-height: calc(100vh - 56px);
        }
        .status-badge {
            width: 80px;
        }
        .device-status {
            width: 70px;
            text-align: center;
        }
        .shift-color-block {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
        }
        .color-preview {
            width: 30px;
            height: 30px;
            display: inline-block;
            border-radius: 5px;
            vertical-align: middle;
        }
        
        /* Light mode specific styles */
        [data-bs-theme=light] {
            --bs-body-bg: #f8f9fa;
            --bs-body-color: #212529;
            --bs-border-color: #dee2e6;
        }
        [data-bs-theme=light] .bg-dark {
            background-color: #f8f9fa !important;
        }
        [data-bs-theme=light] .navbar-dark {
            background-color: #f8f9fa !important;
        }
        [data-bs-theme=light] .navbar-dark .navbar-brand,
        [data-bs-theme=light] .navbar-dark .nav-link {
            color: #212529 !important;
        }
        [data-bs-theme=light] .navbar-dark .nav-link.active {
            color: #0d6efd !important;
        }
        [data-bs-theme=light] .footer {
            background-color: #f8f9fa !important;
        }
        [data-bs-theme=light] .footer .text-muted {
            color: #6c757d !important;
        }
        [data-bs-theme=light] .card {
            background-color: #fff;
            border-color: #dee2e6;
        }
        [data-bs-theme=light] .table {
            color: #212529;
            border-color: #dee2e6;
        }
        [data-bs-theme=light] .list-group-item {
            background-color: #fff;
            color: #212529;
            border-color: #dee2e6;
        }
        
        /* Text visibility in cards for both themes */
        [data-bs-theme=light] .card.bg-primary,
        [data-bs-theme=light] .card.bg-success,
        [data-bs-theme=light] .card.bg-info,
        [data-bs-theme=light] .card.bg-warning,
        [data-bs-theme=light] .card.bg-danger,
        [data-bs-theme=light] .card.bg-secondary {
            color: white !important;
        }
        
        /* Theme toggle button styles */
        #themeToggle {
            padding: 0.25rem 0.75rem;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
        }
        
        /* Select2 custom styling for improved dropdowns */
        .select2-container--bootstrap-5 .select2-dropdown {
            border-color: var(--bs-border-color);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            border-radius: 0.25rem;
        }
        
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            padding-left: 0;
            color: var(--bs-body-color);
        }
        
        /* Styles for dark mode */
        [data-bs-theme=dark] .select2-container--bootstrap-5 .select2-selection {
            background-color: #2b3035;
            border-color: #495057;
            color: #fff;
        }
        
        [data-bs-theme=dark] .select2-container--bootstrap-5 .select2-dropdown {
            background-color: #2b3035;
            border-color: #495057;
        }
        
        [data-bs-theme=dark] .select2-container--bootstrap-5 .select2-dropdown .select2-results__option {
            color: #fff;
        }
        
        [data-bs-theme=dark] .select2-container--bootstrap-5 .select2-dropdown .select2-results__option[aria-selected=true] {
            background-color: #0d6efd;
        }
        
        [data-bs-theme=dark] .select2-container--bootstrap-5 .select2-dropdown .select2-results__option--highlighted {
            background-color: #2c3136;
        }
        
        /* Select2 placeholder color */
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__placeholder {
            color: #6c757d;
        }

        /* custom css */
        [data-bs-theme=light] .text-muted {
            color: #3c445c !important;
        }
        [data-bs-theme=dark] .text-muted {
            color: #a694ff !important;
        }

.form-text {
    color : #726e6e !important;
}
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-clock-history"></i>
                MIR AMS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    {% if current_user.role != 'employee' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.path.startswith('/attendance') %}active{% endif %}" href="#" id="attendanceDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-calendar-check"></i> Attendance 
                            {% if missing_punches_count and missing_punches_count > 0 %}
                            <span class="badge rounded-pill bg-danger">{{ missing_punches_count }}</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.index') }}">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                            
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.daily') }}">
                                    <i class="bi bi-calendar-day"></i> Daily View
                                </a>
                            </li>
                            {% if current_user.has_role('hr') %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.raw_logs') }}">
                                    <i class="bi bi-list-columns"></i> Raw Logs {{current_user.roles}}
                                </a>
                            </li>
                            {% endif %}
                            

                            <li><hr class="dropdown-divider"></li>
                            {% if current_user.has_role('hr') %}
                           
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.missing_punches') }}">
                                    <i class="bi bi-exclamation-triangle"></i> Missing Punches
                                    {% if missing_punches_count and missing_punches_count > 0 %}
                                    <span class="badge rounded-pill bg-danger">{{ missing_punches_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.manual_entry') }}">
                                    <i class="bi bi-pencil-square"></i> Manual Entry
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.batch_entry') }}">
                                    <i class="bi bi-people"></i> Batch Entry
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.import_csv') }}">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Import CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.process_all_logs') }}">
                                    <i class="bi bi-cpu"></i> Process All Logs
                                </a>
                            </li>
                            {% endif %}

                        </ul>
                    </li>
                    {% endif %}
                    {% if current_user.role != 'employee' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.path.startswith('/shifts') %}active{% endif %}" href="#" id="shiftsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-clock"></i> Shifts
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('shifts.index') }}">
                                    <i class="bi bi-clock"></i> Shift Management
                                </a>
                            </li>
                            {% if current_user.has_role('hr') %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('shifts.assign_shift') }}">
                                    <i class="bi bi-calendar-plus"></i> Assign Shifts
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('shifts.scheduler') }}">
                                    <i class="bi bi-calendar-range"></i> Scheduler
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}


                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.path.startswith('/reports') %}active{% endif %}" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-file-earmark-bar-graph"></i> Reports
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.dashboard') }}">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                            {% if current_user.has_role('hr') %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('attendance.missing_attendance') }}">
                                    <i class="bi bi-clock-history"></i> Missing Atendance Request
                                </a>
                            </li>
                            {% endif %}
                            {% if current_user.role != 'employee' %}
                            {% if current_user.has_role('hr') %}

                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.daily') }}">
                                    <i class="bi bi-calendar-day"></i> Daily Report
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.weekly') }}">
                                    <i class="bi bi-calendar-week"></i> Weekly Report
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.monthly') }}">
                                    <i class="bi bi-calendar-month"></i> Monthly Report
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.absent') }}">
                                    <i class="bi bi-person-x"></i> Absent Report
                                </a>
                            </li>
                            {% endif %}
                            {% endif %}
                        </ul>
                    </li>

                    {% if current_user.has_role('hr') %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.path.startswith('/overtime') %}active{% endif %}" href="{{ url_for('overtime.index') }}">
                            <i class="bi bi-clock-history"></i> Overtime
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.path.startswith('/devices') %}active{% endif %}" href="{{ url_for('devices.index') }}">
                            <i class="bi bi-upc-scan"></i> Devices
                        </a>
                    </li>
                    {% endif %}
                    
                    {% if current_user.has_role('supervisor') or current_user.has_role('hr') %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.path.startswith('/admin') %}active{% endif %}" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> HR
                        </a>
                        <ul class="dropdown-menu">

                    <li class="dropdown-item">
                        <a class="nav-link {% if request.path.startswith('/bonus') %}active{% endif %}" href="{{ url_for('bonus.index') }}">
                            <i class="bi bi-award"></i> Bonus System
                        </a>
                    </li>
{% if current_user.has_role('hr') %}
                    <li class="dropdown-item">
                        <a class="nav-link {% if request.path.startswith('users') %}active{% endif %}" href="{{ url_for('admin.users') }}">
                            <i class="bi bi-award"></i> User
                        </a>
                    </li>
{% endif %}
                    
                    {% if current_user.has_role('hr') %}
                     <li>
                                <a class="dropdown-item" href="{{ url_for('admin.employees') }}">
                                    <i class="bi bi-people"></i> Employees
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('employees.index') }}">
                                    <i class="bi bi-person-workspace"></i> Employee Management
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.overtime_eligibility') }}">
                                    <i class="bi bi-clock-history"></i> Overtime Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.weekend_config') }}">
                                    <i class="bi bi-calendar-week"></i> Weekend Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.employee_weekend_config') }}">
                                    <i class="bi bi-person-badge"></i> Employee Weekend Config
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}
                    
                    {% if current_user.has_role('hr') %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.path.startswith('/supervisor') %}active{% endif %}" href="{{ url_for('supervisor.reassign_supervisor') }}">
                            <i class="bi bi-person-badge"></i> Supervisor Management
                        </a>
                    </li>
                    {% endif %}
                    
                    {% if current_user.is_admin %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.path.startswith('/admin') %}active{% endif %}" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.index') }}">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.employees') }}">
                                    <i class="bi bi-people"></i> Employees
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('employees.index') }}">
                                    <i class="bi bi-person-workspace"></i> Employee Management
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.overtime_eligibility') }}">
                                    <i class="bi bi-clock-history"></i> Overtime Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.weekend_config') }}">
                                    <i class="bi bi-calendar-week"></i> Weekend Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('admin.employee_weekend_config') }}">
                                    <i class="bi bi-person-badge"></i> Employee Weekend Config
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('bonus.hr_dashboard') }}">
                                    <i class="bi bi-award"></i> Bonus Management
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
                
                <ul class="navbar-nav ms-auto">
                    <!-- Theme Toggler -->
                    <li class="nav-item">
                        <button class="btn nav-link" id="themeToggle" title="Toggle Theme">
                            <i class="bi bi-sun-fill" id="lightThemeIcon"></i>
                            <i class="bi bi-moon-fill" id="darkThemeIcon" style="display: none;"></i>
                        </button>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                    <i class="bi bi-person"></i> Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.change_password') }}">
                                    <i class="bi bi-key"></i> Change Password
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    



    <!-- Admin Impersonation Banner -->
    {% if current_user.is_authenticated and session.get('original_admin_user_id') %}
    <div class="alert alert-warning m-0 border-0 rounded-0 text-center">
        <div class="container">
            <i class="bi bi-person-fill-gear"></i>
            <strong>Admin Mode:</strong> You are viewing as <strong>{{ current_user.username }}</strong>
            <a href="{{ url_for('admin.switch_back_to_admin') }}" class="btn btn-sm btn-outline-dark ms-3">
                <i class="bi bi-arrow-left-circle"></i> Back to Admin
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Flash Messages -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    
    <!-- Main Content -->
    <div class="container-fluid py-4">
        <div class="row">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-dark">
        <div class="container text-center">
            <span class="text-muted">MIR AMS &copy; {{ now.year }}</span>
        </div>
    </footer>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Print JS -->
    <script src="{{ url_for('static', filename='js/print.js') }}"></script>
    
    <!-- Additional JS based on page -->
    {% block extra_js %}{% endblock %}
    
</body>
</html>
